<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Document Analyzer</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <main class="container">
    <header class="header">
      <h1>Document Analyzer</h1>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
      <button class="tab-btn active" data-tab="library">Document Library</button>
      <button class="tab-btn" data-tab="analyzer">Document Analyzer</button>
      <button class="tab-btn" data-tab="desk">Desk</button>
      <button class="tab-btn" data-tab="governance">Governance <span id="taskBadge" class="tab-badge" style="display:none;">0</span></button>
      <button class="tab-btn" data-tab="statistics">Statistics</button>
      <button class="tab-btn" data-tab="settings">Settings</button>
    </nav>

    <!-- Tab 1: Document Library -->
    <section class="tab-content active" id="tab-library">
      <div class="card">
        <h2 class="section-title">Document Library</h2>
        <p class="subtle" style="margin-bottom: 1rem;">Upload and manage documents for Q&A and cross-referencing.</p>

        <!-- Upload Form -->
        <div class="upload-section">
          <h3>Upload Document</h3>
          <div class="upload-form">
            <div class="upload-row">
              <input type="file" id="uploadFileInput" accept=".pdf,.docx" />
              <select id="uploadCategoryInput" class="category-input">
                <option value="">No Category</option>
                <option value="Finance">Finance</option>
                <option value="Compliance">Compliance</option>
                <option value="Operations">Operations</option>
                <option value="HR">HR</option>
                <option value="Board">Board</option>
                <option value="IT">IT</option>
              </select>
              <button id="uploadBtn" type="button" class="btn-primary">Upload</button>
            </div>
            <p class="hint">Supported formats: PDF, DOCX (max 10MB)</p>
          </div>
        </div>

        <div class="library-divider"></div>

        <div class="library-actions">
          <button id="scanBtn" type="button" class="btn-secondary">Scan Server Folder</button>
          <button id="scanGDriveBtn" type="button" class="btn-secondary">Scan Google Drive</button>
          <button id="processAllBtn" type="button" class="btn-secondary">Process All</button>
          <span id="embeddingStatus" class="embedding-status"></span>
          <span id="gdriveStatus" class="gdrive-status" style="display:none;"></span>
        </div>

        <div id="libraryStatus" class="status" style="margin-top: 1rem; display: none;"></div>

        <div id="documentList" class="document-list">
          <p class="subtle">No documents found. Upload a document or scan the server folder.</p>
        </div>
      </div>
    </section>

    <!-- Tab 2: Document Analyzer -->
    <section class="tab-content" id="tab-analyzer">
      <div class="card">
        <h2 class="section-title">Document Analyzer</h2>
        <p class="subtle" style="margin-bottom: 1rem;">Translate, summarize, and extract key information from documents.</p>

        <form id="analyzeForm">
          <div class="field">
            <label for="analyzerFileInput">Document (PDF or DOCX)</label>
            <input id="analyzerFileInput" type="file"
              accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
              required />
          </div>

          <div class="field">
            <label>Outputs (choose at least 1)</label>
            <div class="checks" id="analyzerOutputs">
              <label class="check">
                <input type="checkbox" name="analyzerOutputs" value="translation" checked />
                <span>Full translation</span>
              </label>
              <label class="check">
                <input type="checkbox" name="analyzerOutputs" value="summary" checked />
                <span>Summary</span>
              </label>
              <label class="check">
                <input type="checkbox" name="analyzerOutputs" value="key_points" />
                <span>Key points</span>
              </label>
              <label class="check">
                <input type="checkbox" name="analyzerOutputs" value="todos" />
                <span>Department to-do list</span>
              </label>
            </div>
          </div>

          <div class="field">
            <label for="analyzerTranslateTo">Translate to</label>
            <select id="analyzerTranslateTo" required>
              <option value="English">English</option>
              <option value="Polish">Polish</option>
              <option value="German">German</option>
              <option value="French">French</option>
              <option value="Spanish">Spanish</option>
            </select>
          </div>

          <div class="actions">
            <button id="analyzeBtn" type="submit" disabled>Analyze</button>
            <button id="analyzerClearBtn" type="button">Clear</button>
          </div>

          <div id="analyzerStatus" class="status">Choose at least one output to enable Analyze.</div>
        </form>
      </div>

      <!-- Analyzer Results -->
      <section class="card" id="analyzerResultsCard" style="display: none;">
        <div class="result-block" id="analyzerTranslationBlock" style="display: none;">
          <details class="disclosure" id="analyzerTranslatedDisclosure" open>
            <summary>
              <span>Translated document</span>
              <span class="subtle">Click to expand/collapse</span>
            </summary>
            <div style="margin-top:10px;">
              <div class="result-actions">
                <button id="exportAnalyzerTranslationBtn" type="button" class="btn-export">Export</button>
              </div>
              <div id="analyzerTranslatedDoc" class="result-box subtle" style="margin-top:10px;">No data yet.</div>
            </div>
          </details>
        </div>

        <div class="result-block" id="analyzerSummaryBlock" style="display: none;">
          <h3>Summary</h3>
          <div id="analyzerSummary" class="result-box subtle">No data yet.</div>
        </div>

        <div class="result-block" id="analyzerKeyPointsBlock" style="display: none;">
          <h3>Key points</h3>
          <div id="analyzerKeyPoints" class="result-box subtle">No data yet.</div>
        </div>

        <div class="result-block" id="analyzerTodosBlock" style="display: none;">
          <h3>To-dos by department</h3>
          <div class="result-actions">
            <button id="exportAnalyzerTodosBtn" type="button" class="btn-export">Export</button>
          </div>
          <div id="analyzerTodos" class="result-box subtle" style="margin-top:10px;">No data yet.</div>
        </div>
      </section>
    </section>

    <!-- Tab 3: Desk -->
    <section class="tab-content" id="tab-desk">
      <div class="card">
        <h2 class="section-title">Desk</h2>
        <p class="subtle" style="margin-bottom: 1rem;">Ask questions, cross-reference external documents, and generate response templates.</p>

        <!-- Q&A Section -->
        <div class="desk-section">
          <h3>Ask a Question</h3>
          <p class="hint">Select documents from your library to search through.</p>

          <div class="field">
            <div class="field-header">
              <label>Select Library Documents</label>
              <button type="button" id="qaSelectAllBtn" class="btn-select-all">Select All</button>
            </div>
            <div id="deskDocumentSelect" class="document-select-list">
              <p class="subtle">Loading documents...</p>
            </div>
          </div>

          <div class="field">
            <textarea id="questionInput" rows="3" placeholder="Type your question here..."></textarea>
          </div>

          <div class="actions">
            <button id="askBtn" type="button" disabled>Ask Question</button>
          </div>

          <div id="qaStatus" class="status" style="margin-top: 1rem; display: none;"></div>

          <div id="answerSection" class="answer-section" style="display: none;">
            <h4>Answer</h4>
            <div id="answerContent" class="answer-content"></div>

            <div id="sourcesSection" style="display: none;">
              <h5>Sources</h5>
              <div id="sourcesList" class="sources-list"></div>
            </div>
          </div>
        </div>

        <div class="library-divider"></div>

        <!-- Cross-Reference & Template Section -->
        <div class="desk-section">
          <h3>Cross-Reference & Response Template</h3>
          <p class="hint">Upload external documents to analyze and generate response templates. Optionally cross-reference with library documents.</p>

          <div class="field">
            <label for="deskExternalFile">External Document (PDF or DOCX)</label>
            <input id="deskExternalFile" type="file"
              accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
            <p class="hint">This is the document you want to respond to.</p>
          </div>

          <div class="field">
            <label>Outputs</label>
            <div class="checks" id="deskOutputs">
              <label class="check">
                <input type="checkbox" name="deskOutputs" value="cross_reference" />
                <span>Cross-reference findings</span>
              </label>
              <label class="check">
                <input type="checkbox" name="deskOutputs" value="generate_template" checked />
                <span>Generate response template</span>
              </label>
            </div>
          </div>

          <div class="field" id="deskPrefillField">
            <label class="check prefill-check">
              <input type="checkbox" id="deskPrefillToggle" />
              <span>Pre-fill response template with data from library documents</span>
            </label>
            <p class="hint">When enabled, the template will be automatically filled with data found in your library documents.</p>
          </div>

          <div class="field" id="deskCrossRefField">
            <div class="field-header">
              <label>Select Library Documents <span class="hint-inline">(required for cross-reference or pre-fill)</span></label>
              <button type="button" id="crossRefSelectAllBtn" class="btn-select-all">Select All</button>
            </div>
            <div id="deskCrossRefSelect" class="document-select-list categorized">
              <p class="subtle">Loading documents...</p>
            </div>
          </div>

          <div class="field">
            <label for="deskTranslateTo">Output language</label>
            <select id="deskTranslateTo">
              <option value="English">English</option>
              <option value="Polish">Polish</option>
              <option value="German">German</option>
              <option value="French">French</option>
              <option value="Spanish">Spanish</option>
            </select>
          </div>

          <div class="actions">
            <button id="deskAnalyzeBtn" type="button" disabled>Analyze & Generate</button>
            <button id="deskClearBtn" type="button">Clear</button>
            <div id="deskModelIndicator" class="model-indicator"></div>
          </div>

          <div id="deskStatus" class="status" style="display: none;"></div>
        </div>
      </div>

      <!-- Desk Results -->
      <section class="card" id="deskResultsCard" style="display: none;">
        <div class="result-block" id="deskCrossRefBlock" style="display: none;">
          <h3>Cross-reference Findings</h3>
          <div id="deskCrossRef" class="result-box subtle">No data yet.</div>
        </div>

        <div class="result-block" id="deskTemplateBlock" style="display: none;">
          <h3>Response Template</h3>
          <div class="result-actions">
            <button id="exportDeskTemplateBtn" type="button" class="btn-export">Export</button>
          </div>
          <div id="deskTemplateBox" class="result-box subtle" style="margin-top:10px;">No data yet.</div>
        </div>
      </section>
    </section>

    <!-- Tab 4: Governance -->
    <section class="tab-content" id="tab-governance">
      <div class="card">
        <h2 class="section-title">Governance Dashboard</h2>
        <p class="subtle" style="margin-bottom: 1rem;">Manage policies, tasks, audit trail, and legal holds.</p>

        <!-- Tasks Section -->
        <div class="desk-section">
          <div class="field-header">
            <h3>Tasks <span id="openTaskCount" class="task-count"></span></h3>
            <select id="taskStatusFilter" class="category-input" style="width: auto;">
              <option value="open">Open</option>
              <option value="resolved">Resolved</option>
              <option value="dismissed">Dismissed</option>
              <option value="">All</option>
            </select>
          </div>
          <div id="tasksList" class="tasks-list">
            <p class="subtle">No tasks.</p>
          </div>
        </div>

        <div class="library-divider"></div>

        <!-- Policy Rules Section -->
        <div class="desk-section">
          <div class="field-header">
            <h3>Policy Rules</h3>
            <button id="addPolicyBtn" type="button" class="btn-secondary">Add Policy</button>
          </div>
          <div id="policiesList" class="policies-list">
            <p class="subtle">No policies defined.</p>
          </div>
        </div>

        <!-- Add/Edit Policy Form (hidden by default) -->
        <div id="policyForm" class="card policy-form" style="display: none;">
          <h3 id="policyFormTitle">Add Policy Rule</h3>
          <input type="hidden" id="policyEditId" value="" />
          <div class="field">
            <label for="policyName">Policy Name</label>
            <input type="text" id="policyName" placeholder="e.g. EU Contract Retention" />
          </div>
          <div class="field">
            <label for="policyConditionField">Condition Field</label>
            <select id="policyConditionField">
              <option value="doc_type">Document Type</option>
              <option value="jurisdiction">Jurisdiction</option>
              <option value="category">Department</option>
              <option value="client">Client</option>
            </select>
          </div>
          <div class="field">
            <label for="policyConditionValue">Condition Value</label>
            <input type="text" id="policyConditionValue" placeholder="e.g. contract, EU, Finance" />
          </div>
          <div class="field">
            <label for="policyActionType">Action</label>
            <select id="policyActionType">
              <option value="set_retention">Set Retention</option>
              <option value="require_approval">Require Approval</option>
              <option value="add_tag">Add Tag</option>
              <option value="flag_review">Flag for Review</option>
            </select>
          </div>
          <div class="field" id="policyRetentionField">
            <label for="policyRetentionYears">Retention Years</label>
            <input type="number" id="policyRetentionYears" min="1" max="99" value="5" />
          </div>
          <div class="field" id="policyTagField" style="display: none;">
            <label for="policyTagValue">Tag to Add</label>
            <input type="text" id="policyTagValue" placeholder="e.g. regulated" />
          </div>
          <div class="actions">
            <button id="savePolicyBtn" type="button" class="btn-primary">Save Policy</button>
            <button id="cancelPolicyBtn" type="button" class="btn-secondary">Cancel</button>
          </div>
        </div>

        <div class="library-divider"></div>

        <!-- Audit Log Section -->
        <div class="desk-section">
          <div class="field-header">
            <h3>Audit Log</h3>
            <button id="refreshAuditBtn" type="button" class="btn-secondary">Refresh</button>
          </div>
          <div id="auditLog" class="audit-log">
            <p class="subtle">No audit entries.</p>
          </div>
        </div>

        <div class="library-divider"></div>

        <!-- Maintenance Section -->
        <div class="desk-section">
          <h3>Maintenance</h3>
          <p class="hint">Run periodic checks: retention, unconfirmed tags, Google Drive sync.</p>
          <div class="actions" style="margin-top: 0.5rem;">
            <button id="runMaintenanceBtn" type="button" class="btn-secondary">Run Maintenance Now</button>
            <span id="maintenanceStatus" class="settings-status"></span>
          </div>
          <div id="maintenanceResult" style="display: none; margin-top: 1rem;"></div>
        </div>

        <div class="library-divider"></div>

        <!-- Legal Holds Section -->
        <div class="desk-section">
          <div class="field-header">
            <h3>Legal Holds</h3>
            <button id="addLegalHoldBtn" type="button" class="btn-secondary">Add Hold</button>
          </div>
          <div id="legalHoldsList" class="legal-holds-list">
            <p class="subtle">No legal holds.</p>
          </div>
        </div>

        <!-- Add Legal Hold Form (hidden by default) -->
        <div id="legalHoldForm" class="card" style="display: none;">
          <h3>Create Legal Hold</h3>
          <div class="field">
            <label for="holdMatterName">Matter Name</label>
            <input type="text" id="holdMatterName" placeholder="e.g. Acme Corp Investigation" />
          </div>
          <div class="field">
            <label for="holdScopeKeywords">Keywords (comma-separated)</label>
            <input type="text" id="holdScopeKeywords" placeholder="e.g. merger, acquisition, acme" />
          </div>
          <div class="field">
            <label for="holdScopeClients">Clients (comma-separated)</label>
            <input type="text" id="holdScopeClients" placeholder="e.g. Acme Corp, Beta Inc" />
          </div>
          <div class="actions">
            <button id="saveLegalHoldBtn" type="button" class="btn-primary">Create Hold</button>
            <button id="cancelLegalHoldBtn" type="button" class="btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Tab 5: Statistics -->
    <section class="tab-content" id="tab-statistics">
      <div class="card">
        <h2 class="section-title">Statistics</h2>
        <p class="subtle" style="margin-bottom: 1rem;">View token usage from your last action.</p>

        <div id="statsContent">
          <div class="stats-empty">
            <p class="subtle">No statistics available yet. Perform an action (ask a question, analyze a document, or use the desk) to see token usage.</p>
          </div>
        </div>

        <div class="stats-info">
          <h3>Token Pricing Reference</h3>
          <div class="pricing-table">
            <div class="pricing-row">
              <span class="pricing-service">Claude (Sonnet)</span>
              <span class="pricing-detail">Input: $3.00 / 1M tokens | Output: $15.00 / 1M tokens</span>
            </div>
            <div class="pricing-row">
              <span class="pricing-service">Claude (Haiku)</span>
              <span class="pricing-detail">Input: $0.25 / 1M tokens | Output: $1.25 / 1M tokens</span>
            </div>
            <div class="pricing-row">
              <span class="pricing-service">Voyage AI (voyage-3-lite)</span>
              <span class="pricing-detail">$0.02 / 1M tokens</span>
            </div>
          </div>
          <p class="hint" style="margin-top: 1rem;">
            Token counts are estimates. Claude tokens are reported directly from the API.
            Voyage AI tokens are estimated as ~1 token per 4 characters.
          </p>
        </div>
      </div>
    </section>

    <!-- Tab 5: Settings -->
    <section class="tab-content" id="tab-settings">
      <div class="card">
        <h2 class="section-title">Settings</h2>
        <p class="subtle" style="margin-bottom: 1.5rem;">Configure token optimization settings to balance cost and quality.</p>

        <div class="settings-section">
          <h3>Token Optimization Options</h3>
          <p class="hint" style="margin-bottom: 1rem;">These settings help reduce token usage while maintaining output quality. Disable them if you experience quality issues.</p>

          <div class="settings-list">
            <!-- Use Haiku for extraction -->
            <div class="setting-item">
              <div class="setting-info">
                <label class="setting-label" for="settingHaiku">Use Haiku for extraction tasks</label>
                <p class="setting-description">Use Claude Haiku (cheaper, faster) for extracting questions from documents instead of Sonnet. Saves ~90% on extraction costs.</p>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input type="checkbox" id="settingHaiku" checked />
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- Skip translation if same language -->
            <div class="setting-item">
              <div class="setting-info">
                <label class="setting-label" for="settingSkipTranslation">Skip translation if same language</label>
                <p class="setting-description">Automatically detect if the document is already in the target language and skip translation. Uses language detection with 70%+ confidence threshold.</p>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input type="checkbox" id="settingSkipTranslation" checked />
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- Relevance threshold -->
            <div class="setting-item">
              <div class="setting-info">
                <label class="setting-label" for="settingRelevanceThreshold">Use relevance threshold filtering</label>
                <p class="setting-description">Filter out low-relevance search results before sending to Claude. Reduces context size and improves response quality.</p>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input type="checkbox" id="settingRelevanceThreshold" checked />
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- Relevance threshold value slider -->
            <div class="setting-item setting-sub-item" id="relevanceThresholdValueSetting">
              <div class="setting-info">
                <label class="setting-label" for="settingRelevanceValue">Relevance threshold value</label>
                <p class="setting-description">Minimum relevance score (0-100%). Results below this threshold are filtered out. Lower = more results, higher = stricter filtering.</p>
              </div>
              <div class="setting-control setting-control-slider">
                <input type="range" id="settingRelevanceValue" min="0" max="100" value="25" class="slider" />
                <span id="relevanceValueDisplay" class="slider-value">25%</span>
              </div>
            </div>

            <!-- Minimum results guarantee -->
            <div class="setting-item setting-sub-item" id="minResultsSetting">
              <div class="setting-info">
                <label class="setting-label" for="settingMinResults">Minimum results guarantee</label>
                <p class="setting-description">Always return at least this many results, even if they fall below the relevance threshold.</p>
              </div>
              <div class="setting-control setting-control-number">
                <input type="number" id="settingMinResults" min="1" max="10" value="3" class="number-input" />
              </div>
            </div>
          </div>
        </div>

        <div class="library-divider"></div>

        <div class="settings-actions">
          <button id="saveSettingsBtn" type="button" class="btn-primary">Save Settings</button>
          <button id="resetSettingsBtn" type="button" class="btn-secondary">Reset to Defaults</button>
          <span id="settingsStatus" class="settings-status"></span>
        </div>

        <div class="library-divider"></div>

        <div class="settings-section">
          <h3>Google Drive Integration</h3>
          <p class="hint" style="margin-bottom: 1rem;">Connect to publicly shared Google Drive folders. Requires a Google API Key with the Drive API enabled. Only files shared as "Anyone with the link" will be accessible.</p>

          <div class="settings-list">
            <div class="setting-item">
              <div class="setting-info">
                <label class="setting-label" for="settingGdriveApiKey">Google API Key</label>
                <p class="setting-description">Your Google Cloud API Key with Drive API enabled. Create one at <em>console.cloud.google.com > APIs & Services > Credentials</em>.</p>
              </div>
              <div class="setting-control setting-control-text">
                <input type="password" id="settingGdriveApiKey" placeholder="AIza..." class="text-input" />
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <label class="setting-label" for="settingGdriveFolderId">Google Drive Folder ID</label>
                <p class="setting-description">The folder ID from the Drive URL. Open your shared folder and copy the ID after <em>/folders/</em> in the URL.</p>
              </div>
              <div class="setting-control setting-control-text">
                <input type="text" id="settingGdriveFolderId" placeholder="1ABC2DEF3GHI..." class="text-input" />
              </div>
            </div>
          </div>

          <div class="settings-actions" style="margin-top: 1rem;">
            <button id="saveGdriveSettingsBtn" type="button" class="btn-primary">Save Google Drive Settings</button>
            <span id="gdriveSettingsStatus" class="settings-status"></span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Document Metadata Modal -->
  <div id="metadataModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>Edit Document Metadata</h3>
      <input type="hidden" id="metadataDocId" />
      <div class="field">
        <label for="metaDocType">Document Type</label>
        <select id="metaDocType">
          <option value="">Unknown</option>
          <option value="contract">Contract</option>
          <option value="invoice">Invoice</option>
          <option value="letter">Letter</option>
          <option value="report">Report</option>
          <option value="application">Application</option>
          <option value="policy">Policy</option>
          <option value="memo">Memo</option>
          <option value="minutes">Minutes</option>
          <option value="form">Form</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="field">
        <label for="metaClient">Client</label>
        <input type="text" id="metaClient" placeholder="Client or counterparty" />
      </div>
      <div class="field">
        <label for="metaJurisdiction">Jurisdiction</label>
        <select id="metaJurisdiction">
          <option value="">Unknown</option>
          <option value="EU">EU</option>
          <option value="US">US</option>
          <option value="UK">UK</option>
          <option value="DE">DE</option>
          <option value="PL">PL</option>
          <option value="FR">FR</option>
          <option value="ES">ES</option>
          <option value="international">International</option>
        </select>
      </div>
      <div class="field">
        <label for="metaTags">Tags (comma-separated)</label>
        <input type="text" id="metaTags" placeholder="e.g. urgent, kyc, compliance" />
      </div>
      <div class="field">
        <label for="metaStatus">Status</label>
        <select id="metaStatus">
          <option value="draft">Draft</option>
          <option value="in_review">In Review</option>
          <option value="approved">Approved</option>
          <option value="archived">Archived</option>
        </select>
      </div>
      <div class="actions">
        <button id="saveMetadataBtn" type="button" class="btn-primary">Save</button>
        <button id="cancelMetadataBtn" type="button" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
